<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Înregistrare Bon</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* minimal suggestion styles */
        .suggestions { list-style:none; margin:0; padding:0; border:1px solid #ccc; max-height:200px; overflow-y:auto; background:white; position:absolute; width:320px; z-index:50 }
        .suggestions li { padding:6px 8px; cursor:pointer }
        .suggestions li:hover { background:#f0f0f0 }
        .suggestions li.highlight { background:#e0eaff }
        #product_box_line { width:320px }
        .hidden { display:none }
        .line-items { margin-top:12px }
        .line-items li { padding:6px 0 }
        .receipt-header { border:1px solid #ddd; padding:10px; margin-bottom:8px }
    </style>
    <script>
        // simple debounce
        function debounce(fn, wait){ let t; return function(...a){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,a), wait) } }
    </script>
</head>
<body>
    <div class="navbar">
        <a href="/">Acasă</a>
        <a href="/cheltuieli">Cheltuieli</a>
        <a href="/reports">Rapoarte</a>
    </div>
    <div class="container">
        <h1>Introducere bon (receipt)</h1>

        <div class="receipt-header">
            <h2>Informații bon</h2>
            <label>Magazin</label>
            <select id="header_store_id">
                <option value="" selected disabled>Alege magazinul</option>
                {% for s in stores %}
                    <option value="{{ s[0] }}">{{ s[1] }}</option>
                {% endfor %}
            </select>
            <p>Dacă magazinul nu este în listă, <a href="/stores/new">adaugă magazin</a>.</p>
            <label>Număr bon</label>
            <input type="text" id="header_nr_bon" placeholder="Număr bon (opțional)">
            <label>Data</label>
            <input type="date" id="header_date">
            <button id="start_receipt">Pornește bon</button>
        </div>

        <div id="receipt_area" class="hidden">
            <h2>Adaugă produse (bon curent <span id="current_receipt_id"></span>)</h2>
            <div>
                <label>Produs</label>
                <input type="hidden" id="product_id_hidden_line" value="">
                <input type="text" id="product_box_line" autocomplete="off" placeholder="Tastează pentru sugestii">
                <ul id="product_suggestions_line" class="suggestions" style="display:none"></ul>
                <div id="new-product-fields-line">
                    <p>Categoria (pentru produs nou)</p>
                    <select id="category_id_line">
                        <option value="" selected>Alege categoria</option>
                        {% for cat in categories %}
                            <option value="{{ cat[0] }}">{{ cat[1] }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div>
                <label>Preț</label>
                <input type="number" step="0.01" id="line_price" value="0.00">
                <label>Cantitate</label>
                <input type="number" step="0.01" id="line_quantity" value="1">
                <label>Discount (lei)</label>
                <input type="number" step="0.01" id="line_discount" value="0.00">
                <button id="add_line">Adaugă linie</button>
            </div>

            <h3>Articole adăugate</h3>
            <ul id="line_items_list" class="line-items"></ul>

            <div style="margin-top:10px">
                <button id="complete_receipt">Finalizează bon</button>
                <button id="cancel_receipt">Anulează</button>
            </div>
        </div>

        <a href="/">⬅️ Înapoi</a>
    </div>

    <script>
        // --- receipt lifecycle ---
        let current_receipt_id = null;

        document.getElementById('start_receipt').addEventListener('click', async function(){
            const startBtn = document.getElementById('start_receipt');
            const store_id = document.getElementById('header_store_id').value;
            const nr_bon = document.getElementById('header_nr_bon').value.trim();
            const date = document.getElementById('header_date').value;
            if(!store_id){ alert('Selectează magazinul'); return }
            // prevent duplicate clicks
            if(startBtn.disabled) return;
            startBtn.disabled = true;
            const form = new URLSearchParams();
            form.append('store_id', store_id);
            form.append('nr_bon', nr_bon);
            form.append('date', date);
            try{
                const res = await fetch('/create_receipt', { method:'POST', body: form });
                if(!res.ok){
                    // try to parse JSON error if present
                    let errText = '';
                    try{ const errJson = await res.json(); errText = errJson.error || JSON.stringify(errJson); }catch(e){ errText = await res.text(); }
                    alert('Eroare la crearea bonului: ' + errText);
                    startBtn.disabled = false;
                    return;
                }
                const data = await res.json();
                if(data && data.success){
                    current_receipt_id = data.receipt_id;
                    document.getElementById('current_receipt_id').textContent = current_receipt_id;
                    document.getElementById('receipt_area').classList.remove('hidden');
                    // disable header inputs while editing
                    document.getElementById('header_store_id').disabled = true;
                    document.getElementById('header_nr_bon').disabled = true;
                    document.getElementById('header_date').disabled = true;
                } else {
                    alert('Eroare la crearea bonului');
                }
            }catch(e){
                console.error('start_receipt error', e);
                alert('Eroare la crearea bonului (network): ' + e.message);
            } finally{
                startBtn.disabled = false;
            }
        });

        document.getElementById('cancel_receipt').addEventListener('click', async function(){
            if(current_receipt_id){
                // ask server to delete receipt and its lines
                const form = new URLSearchParams(); form.append('receipt_id', current_receipt_id);
                try{
                    await fetch('/delete_receipt', { method: 'POST', body: form });
                }catch(e){ console.warn('Failed to delete receipt on server', e); }
            }
            // reset UI
            current_receipt_id = null;
            document.getElementById('receipt_area').classList.add('hidden');
            document.getElementById('header_store_id').disabled = false;
            document.getElementById('header_nr_bon').disabled = false;
            document.getElementById('header_date').disabled = false;
            document.getElementById('line_items_list').innerHTML = '';
            document.getElementById('current_receipt_id').textContent = '';
        });

        document.getElementById('complete_receipt').addEventListener('click', async function(){
            if(!current_receipt_id){ alert('Nu există un bon activ'); return }
            const form = new URLSearchParams();
            form.append('receipt_id', current_receipt_id);
            const res = await fetch('/complete_receipt', { method:'POST', body: form });
            const data = await res.json();
            if(data.success && data.redirect){ window.location.href = data.redirect }
            else alert('Eroare finalizare bon');
        });

        // --- undo toast ---
        function showUndoToast(deleted){
            const container = document.createElement('div'); container.className='undo-toast';
            const txt = document.createElement('div'); txt.textContent = 'Linie ștearsă';
            const undoBtn = document.createElement('button'); undoBtn.className='small-btn undo'; undoBtn.textContent='Undo';
            container.appendChild(txt); container.appendChild(undoBtn);
            document.body.appendChild(container);
            const timer = setTimeout(()=>{ container.remove() }, 8000);
            undoBtn.addEventListener('click', async ()=>{
                clearTimeout(timer);
                // re-add line using add_line_item (deleted contains price/quantity/discount/product_id)
                const form = new URLSearchParams();
                if(deleted.product_id) form.append('product_id', deleted.product_id);
                else form.append('product_name', '');
                form.append('category_id', '');
                form.append('price', deleted.price || 0);
                form.append('quantity', deleted.quantity || 1);
                form.append('discount', deleted.discount || 0);
                form.append('date', deleted.date || document.getElementById('header_date').value);
                form.append('receipt_id', deleted.receipt_id || current_receipt_id);
                try{
                    const res = await fetch('/add_line_item', { method:'POST', body: form });
                    const data = await res.json();
                    if(data.success){
                        // append again to UI (simple approach: reload page or append minimal)
                        location.reload();
                    } else {
                        alert('Undo failed: ' + (data.error||''))
                    }
                }catch(e){ alert('Undo failed') }
                container.remove();
            });
        }

        // --- product suggestions for line items ---
        const productBoxLine = document.getElementById('product_box_line');
        const suggestionsElLine = document.getElementById('product_suggestions_line');
        const productIdHiddenLine = document.getElementById('product_id_hidden_line');
        const newProductFieldsLine = document.getElementById('new-product-fields-line');
        let selectedIndexLine = -1;

        function hideSuggestionsLine(){ suggestionsElLine.style.display='none'; suggestionsElLine.innerHTML=''; }

        async function fetchSuggestionsLine(q){
            if(!q){ hideSuggestionsLine(); productIdHiddenLine.value=''; newProductFieldsLine.style.display='block'; return }
            try{
                const res = await fetch(`/products/search?q=${encodeURIComponent(q)}`);
                const data = await res.json();
                renderSuggestionsLine(data);
            }catch(e){ console.error(e); }
        }

        function renderSuggestionsLine(items){
            suggestionsElLine.innerHTML='';
            if(!items || items.length===0){ hideSuggestionsLine(); newProductFieldsLine.style.display='block'; return }
            items.forEach(it=>{
                const li = document.createElement('li');
                li.textContent = it.name + (it.category ? ' — ' + it.category : '');
                li.dataset.id = it.id;
                li.dataset.name = it.name;
                li.addEventListener('click', ()=>{
                    productBoxLine.value = li.dataset.name + (it.category ? ' — ' + it.category : '');
                    productIdHiddenLine.value = li.dataset.id;
                    hideSuggestionsLine();
                    newProductFieldsLine.style.display='none';
                });
                suggestionsElLine.appendChild(li);
            });
            suggestionsElLine.style.display='block';
        }

        productBoxLine.addEventListener('input', debounce((e)=>{
            const q = e.target.value.trim();
            productIdHiddenLine.value = '';
            selectedIndexLine = -1;
            fetchSuggestionsLine(q);
        }, 200));

        productBoxLine.addEventListener('keydown', function(e){
            const items = suggestionsElLine.querySelectorAll('li');
            if(e.key === 'ArrowDown'){
                if(items.length===0) return;
                selectedIndexLine = (selectedIndexLine + 1) % items.length;
                updateHighlightLine(); e.preventDefault();
            } else if(e.key === 'ArrowUp'){
                if(items.length===0) return;
                selectedIndexLine = (selectedIndexLine - 1 + items.length) % items.length;
                updateHighlightLine(); e.preventDefault();
            } else if(e.key === 'Enter'){
                if(selectedIndexLine >= 0){ selectSuggestionByIndexLine(selectedIndexLine); e.preventDefault(); }
            } else if(e.key === 'Escape'){
                hideSuggestionsLine(); selectedIndexLine = -1;
            }
        });

        function updateHighlightLine(){ const items = suggestionsElLine.querySelectorAll('li'); items.forEach((li,idx)=>{ if(idx===selectedIndexLine) li.classList.add('highlight'); else li.classList.remove('highlight') }); const cur = items[selectedIndexLine]; if(cur){ const rect = cur.getBoundingClientRect(); const pr = suggestionsElLine.getBoundingClientRect(); if(rect.top < pr.top) cur.scrollIntoView(true); else if(rect.bottom > pr.bottom) cur.scrollIntoView(false); } }
        function selectSuggestionByIndexLine(idx){ const items = suggestionsElLine.querySelectorAll('li'); if(idx<0||idx>=items.length) return; items[idx].click(); }

        document.addEventListener('click', function(e){ if(!suggestionsElLine.contains(e.target) && e.target!==productBoxLine){ hideSuggestionsLine(); selectedIndexLine = -1; } });

        // --- add a line to receipt ---
            document.getElementById('add_line').addEventListener('click', async function(){
                if(!current_receipt_id){ alert('Pornește mai întâi un bon'); return }
                const addBtn = document.getElementById('add_line');
                if(addBtn.disabled) return; // prevent double submissions
                addBtn.disabled = true;
            const form = new URLSearchParams();
            form.append('receipt_id', current_receipt_id);
            const prodId = productIdHiddenLine.value;
            if(prodId) form.append('product_id', prodId);
            else form.append('product_name', document.getElementById('product_box_line').value.trim());
            const cat = document.getElementById('category_id_line').value;
            if(cat) form.append('category_id', cat);
            form.append('price', document.getElementById('line_price').value);
            form.append('quantity', document.getElementById('line_quantity').value);
            form.append('discount', document.getElementById('line_discount').value);
            form.append('date', document.getElementById('header_date').value);

            const res = await fetch('/add_line_item', { method:'POST', body: form });
            const data = await res.json();
            if(data.success){
                const ul = document.getElementById('line_items_list');
                const li = document.createElement('li');
                li.className = 'line-item';
                li.dataset.expenseId = data.expense_id;
                const meta = document.createElement('div'); meta.className = 'meta';
                const total = (parseFloat(data.price) * parseFloat(data.quantity) - parseFloat(data.discount || 0)).toFixed(2);
                meta.innerHTML = `<strong>${data.product_name}</strong> <span class="meta">— ${data.quantity} x ${data.price} lei</span>`;
                const right = document.createElement('div');
                right.innerHTML = `<span class="meta">Discount: ${parseFloat(data.discount||0).toFixed(2)} lei</span> <span class="meta" style="margin-left:8px">Total: ${total} lei</span>`;
                const actions = document.createElement('div'); actions.className='line-actions';
                const editBtn = document.createElement('button'); editBtn.className='small-btn edit'; editBtn.textContent='Edit';
                const delBtn = document.createElement('button'); delBtn.className='small-btn delete'; delBtn.textContent='Delete';
                actions.appendChild(editBtn); actions.appendChild(delBtn);
                li.appendChild(meta); li.appendChild(right); li.appendChild(actions);
                ul.appendChild(li);

                // wire delete
                delBtn.addEventListener('click', async ()=>{
                    if(!confirm('Ștergi această linie?')) return;
                    const formD = new URLSearchParams(); formD.append('expense_id', data.expense_id);
                    const resD = await fetch('/delete_expense', { method:'POST', body: formD });
                    const delData = await resD.json();
                    if(delData.success){
                        // offer undo
                        const deleted = delData.deleted;
                        li.remove();
                        showUndoToast(deleted);
                    } else {
                        alert('Eroare la ștergere: ' + (delData.error||''))
                    }
                });

                // wire edit (inline)
                editBtn.addEventListener('click', ()=>{
                    // replace right area with inputs
                    const priceInput = document.createElement('input'); priceInput.type='number'; priceInput.step='0.01'; priceInput.value=data.price; priceInput.className='editable-input';
                    const qtyInput = document.createElement('input'); qtyInput.type='number'; qtyInput.step='0.01'; qtyInput.value=data.quantity; qtyInput.className='editable-input';
                    const discInput = document.createElement('input'); discInput.type='number'; discInput.step='0.01'; discInput.value=data.discount||0; discInput.className='editable-input';
                    const saveBtn = document.createElement('button'); saveBtn.className='small-btn edit'; saveBtn.textContent='Save';
                    const cancelBtn = document.createElement('button'); cancelBtn.className='small-btn undo'; cancelBtn.textContent='Cancel';
                    right.innerHTML=''; right.appendChild(priceInput); right.appendChild(qtyInput); right.appendChild(discInput); right.appendChild(saveBtn); right.appendChild(cancelBtn);

                    saveBtn.addEventListener('click', async ()=>{
                        const formU = new URLSearchParams();
                        formU.append('expense_id', data.expense_id);
                        formU.append('price', priceInput.value);
                        formU.append('quantity', qtyInput.value);
                        formU.append('discount', discInput.value);
                        const resU = await fetch('/update_expense', { method:'POST', body: formU });
                        const upd = await resU.json();
                        if(upd.success){
                            // update UI
                            data.price = upd.price; data.quantity = upd.quantity; data.discount = upd.discount;
                            const newTotal = (upd.price * upd.quantity - upd.discount).toFixed(2);
                            meta.innerHTML = `<strong>${data.product_name}</strong> <span class="meta">— ${data.quantity} x ${data.price} lei</span>`;
                            right.innerHTML = `<span class="meta">Discount: ${parseFloat(data.discount||0).toFixed(2)} lei</span> <span class="meta" style="margin-left:8px">Total: ${newTotal} lei</span>`;
                        } else {
                            alert('Eroare actualizare: ' + (upd.error||''))
                        }
                    });

                    cancelBtn.addEventListener('click', ()=>{
                        // restore display
                        const totalRestore = (parseFloat(data.price) * parseFloat(data.quantity) - parseFloat(data.discount || 0)).toFixed(2);
                        right.innerHTML = `<span class="meta">Discount: ${parseFloat(data.discount||0).toFixed(2)} lei</span> <span class="meta" style="margin-left:8px">Total: ${totalRestore} lei</span>`;
                    });
                });
                // clear line inputs for next entry
                productBoxLine.value = '';
                productIdHiddenLine.value = '';
                document.getElementById('line_price').value = '0.00';
                document.getElementById('line_quantity').value = '1';
                document.getElementById('line_discount').value = '0.00';
                newProductFieldsLine.style.display = 'block';
                hideSuggestionsLine();
                addBtn.disabled = false;
            } else {
                alert('Eroare adăugare linie: ' + (data.error||''))
                addBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
